# Metricbeat Configuration Template for AWX
# Generated by Ansible

metricbeat.config.modules:
  path: /etc/metricbeat/modules.d/*.yml
  reload.enabled: false

# Elasticsearch Output
output.elasticsearch:
  enabled: true
  hosts: {{ elasticsearch_hosts | to_json }}
{% if elasticsearch_username is defined and elasticsearch_password is defined %}
  username: "{{ elasticsearch_username }}"
  password: "{{ elasticsearch_password }}"
{% endif %}
  protocol: "{{ elasticsearch_protocol | default('http') }}"
  loadbalance: true
  compression_level: 0
  escape_html: false

{% if elasticsearch_ssl_enabled | default(false) %}
  ssl:
    enabled: true
    verification_mode: "{{ elasticsearch_ssl_verification_mode | default('certificate') }}"
{% if elasticsearch_ssl_certificate_authorities is defined %}
    certificate_authorities: {{ elasticsearch_ssl_certificate_authorities | to_json }}
{% endif %}
{% endif %}

# Kibana Configuration
setup.kibana:
  host: "{{ kibana_host }}"

# Dashboard and Template Setup
setup.template:
  enabled: {{ setup_template | default(true) | lower }}
  settings:
    index.number_of_shards: 1
    index.codec: best_compression

setup.dashboards:
  enabled: {{ setup_dashboards | default(true) | lower }}

# Processors
processors:
  - add_host_metadata:
      when.not.contains.tags: forwarded
  - add_cloud_metadata: ~
  - add_docker_metadata: ~
  - add_kubernetes_metadata: ~

# Logging Configuration
logging.level: {{ metricbeat_log_level | default('info') }}
logging.to_files: true
logging.files:
  path: /var/log/metricbeat
  name: metricbeat
  keepfiles: 7
  permissions: 0644
  rotateeverybytes: 10485760 # 10MB

# Performance Settings
queue.mem:
  events: 4096
  flush.min_events: 512
  flush.timeout: 5s

# Monitoring (self-monitoring)
monitoring:
  enabled: false

# HTTP endpoint for metrics (optional)
http:
  enabled: false
  port: 5066

# Global tags
tags: ["{{ environment | default('production') }}", "metricbeat"]

# Fields
fields:
  env: "{{ environment | default('production') }}"
  datacenter: "{{ datacenter | default('dc1') }}"
fields_under_root: false
